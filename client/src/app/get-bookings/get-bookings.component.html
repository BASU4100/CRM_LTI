
<div class="container mt-4">
  <h2 class="mb-4">Car Bookings</h2>

  <div *ngIf="showMessage" class="alert alert-success alert-dismissible fade show">
    <span [innerHTML]="responseMessage"></span>
    <button type="button" class="btn-close" (click)="showMessage = false"></button>
  </div>
  <div *ngIf="showError" class="alert alert-danger alert-dismissible fade show">
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="showError = false"></button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Car</th>
          <th>User</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let b of bookingList; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ b.car?.make }} {{ b.car?.model }}</td>
          <td>{{ b.user?.username }}</td>
          <td>{{ b.rentalStartDate }}</td>
          <td>{{ b.rentalEndDate }}</td>

          <td>
            <span class="badge"
                  [class.bg-success]="b.bookingStatus === 'CONFIRMED'"
                  [class.bg-warning]="b.bookingStatus === 'PENDING'"
                  [class.bg-danger]="b.bookingStatus === 'CANCELLED'">
              {{ b.bookingStatus }}
            </span>
          </td>

          <td>
            <span class="badge"
                  [class.bg-success]="b.paymentStatus === 'PAID'"
                  [class.bg-secondary]="b.paymentStatus === 'UNPAID'">
              {{ b.paymentStatus }}
            </span>
          </td>

          <td class="text-end">₹{{ b.totalAmount | number:'1.0-0' }}</td>

          <td>
            <button 
              class="btn btn-sm btn-primary me-1"
              (click)="bookNow(b)"
              [disabled]="b.bookingStatus?.toLowerCase() !== 'pending'">
              Confirm Now
            </button>
          
            <button 
              class="btn btn-sm btn-success"
              (click)="payment(b)"
              [disabled]="(b.paymentStatus||'').toLowerCase() !== 'unpaid'">
              Pay
            </button>
          </td>
        </tr>

        <tr *ngIf="updateId && selectedBooking?.id === updateId" class="table-light">
          <td colspan="9" class="p-3">
            <div class="border rounded p-3 bg-white">
              <h6>Confirm Booking for {{ selectedBooking.user?.username }}</h6>
              <p><strong>Car:</strong> {{ selectedBooking.car?.make }} {{ selectedBooking.car?.model }} | 
                 <strong>Total:</strong> ₹{{ selectedBooking.totalAmount | number:'1.0-0' }}</p>

              <div class="d-flex gap-2">
                <button class="btn btn-primary" (click)="onStatusSubmit()">Update Booking</button>
                <button class="btn btn-secondary" (click)="reset()">Cancel</button>
              </div>
            </div>
          </td>
        </tr>

        <tr *ngIf="paymentId && selectedBooking?.id === paymentId" class="table-light">
          <td colspan="9" class="p-3">
            <form [formGroup]="itemForm" (ngSubmit)="onPaymentSubmit()" class="border rounded p-3 bg-white">
              <h6>Record Payment – ₹{{ selectedBooking.totalAmount | number:'1.0-0' }}</h6>

              <div class="row g-3">
                <div class="col-md-3">
                  <label>Amount</label>
                  <input type="number" class="form-control" formControlName="amount" readonly>
                </div>
                <div class="col-md-3">
                  <label>Date</label>
                  <input type="date" class="form-control" formControlName="paymentDate">
                </div>
                <div class="col-md-3">
                  <label>Method</label>
                  <select class="form-select" formControlName="paymentMethod">
                    <option value="CREDIT_CARD">Credit Card</option>
                    <option value="DEBIT_CARD">Debit Card</option>
                    <option value="UPI">UPI</option>
                    <option value="CASH">Cash</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label>Status</label>
                  <input type="text" class="form-control" formControlName="paymentStatus" readonly>
                </div>
              </div>

              <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-success" [disabled]="itemForm.invalid">
                  Confirm Payment
                </button>
                <button type="button" class="btn btn-secondary" (click)="reset()">Cancel</button>
              </div>
            </form>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="bookingList.length === 0 && !showError" class="text-center py-5 text-muted">
      <p class="lead">No bookings assigned to you.</p>
    </div>
  </div>
</div>

