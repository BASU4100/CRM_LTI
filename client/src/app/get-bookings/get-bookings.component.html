<mat-card class="mat-elevation-z4 full-height">
  <mat-card-title class="mat-headline mb-2 text-center">Recent Bookings</mat-card-title>

  <!-- Success / Error Messages -->
  <mat-card *ngIf="showMessage" class="mb-2 p-1">
    <mat-card-content class="d-flex align-items-center gap-1 py-1">
      <mat-icon color="primary" class="fs-5">check_circle</mat-icon>
      <span [innerHTML]="responseMessage" class="fs-6"></span>
      <button mat-icon-button (click)="showMessage = false" class="ms-auto">
        <mat-icon class="fs-6">close</mat-icon>
      </button>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="showError" class="mb-2 p-1">
    <mat-card-content class="d-flex align-items-center gap-1 py-1">
      <mat-icon color="warn" class="fs-5">error</mat-icon>
      <span class="fs-6">{{ errorMessage }}</span>
      <button mat-icon-button (click)="showError = false" class="ms-auto">
        <mat-icon class="fs-6">close</mat-icon>
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Table + Form Container -->
  <div class="table-container">
    <!-- Table (no matSort) -->
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2" style="width: 100%; overflow: hidden;">

      <!-- Car -->
      <ng-container matColumnDef="car">
        <th mat-header-cell *matHeaderCellDef>Car</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          {{ row.car?.make }} {{ row.car?.model }}
        </td>
      </ng-container>

      <!-- User -->
      <ng-container matColumnDef="user">
        <th mat-header-cell *matHeaderCellDef>User</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          {{ row.user?.username }}
        </td>
      </ng-container>

      <!-- Start -->
      <ng-container matColumnDef="start">
        <th mat-header-cell *matHeaderCellDef>Start</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          {{ row.rentalStartDate }}
        </td>
      </ng-container>

      <!-- End -->
      <ng-container matColumnDef="end">
        <th mat-header-cell *matHeaderCellDef>End</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          {{ row.rentalEndDate }}
        </td>
      </ng-container>

      <ng-container matColumnDef="bookingStatus">
        <th mat-header-cell *matHeaderCellDef class="text-center bold-header">Status</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          <!-- NEW: .status-badge applied -->
          <span class="status-badge" [ngClass]="{
                  'bg-success': row.bookingStatus === 'CONFIRMED',
                  'bg-warning': row.bookingStatus === 'PENDING',
                  'bg-danger' : row.bookingStatus === 'CANCELLED'
                }">
            {{ row.bookingStatus }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="paymentStatus">
        <th mat-header-cell *matHeaderCellDef class="text-center bold-header">Payment</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          <!-- NEW: .status-badge applied (same colours as before) -->
          <span class="status-badge" [ngClass]="{
                  'bg-success' : row.paymentStatus === 'PAID',
                  'bg-secondary': row.paymentStatus === 'UNPAID'
                }">
            {{ row.paymentStatus }}
          </span>
        </td>
      </ng-container>

      <!-- Total -->
      <ng-container matColumnDef="total">
        <th mat-header-cell *matHeaderCellDef>Total</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          ₹{{ row.totalAmount | number:'1.0-0' }}
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let row" class="text-center compact-cell">
          <div class="d-flex justify-content-center gap-2">
            <button mat-stroked-button size="small" color="primary" (click)="bookNow(row)"
              [disabled]="row.bookingStatus !== 'PENDING' || row.paymentStatus === 'UNPAID'" class="w-100">
              Confirm
            </button>
            <button mat-stroked-button size="small" color="accent" (click)="payment(row)"
              [disabled]="row.paymentStatus !== 'UNPAID'" class="w-100">
              Pay
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Header & Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- No records -->
      <tr *matNoDataRow>
        <td colspan="8" class="text-center py-3">
          <mat-icon class="text-muted">search_off</mat-icon>
          <p class="mat-body-1">No payment records found</p>
        </td>
      </tr>
    </table>

    <!-- Confirm Form -->
    <div *ngIf="confirmId && selectedBooking?.id === confirmId" class="p-2">
      <mat-card class="compact-form-card">
        <mat-card-content class="p-2">
          <div class="d-flex gap-1 w-100">
            <p class="mb-1"><strong>Confirm for:</strong> {{ selectedBooking.user?.username }}</p>
            <p class="mb-1"><strong>Car:</strong> {{ selectedBooking.car?.make }} {{ selectedBooking.car?.model }}</p>
            <p class="mb-2"><strong>Total:</strong> ₹{{ selectedBooking.totalAmount | number:'1.0-0' }}</p>
          </div>
          <div class="d-flex gap-1 justify-content-center">
            <button mat-raised-button color="primary" size="small" (click)="onStatusSubmit()">Update</button>
            <button mat-raised-button color="warn" (click)="reset()">
              Cancel
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Payment Form -->
    <div *ngIf="paymentId && selectedBooking?.id === paymentId" class="p-2">
      <mat-card class="compact-form-card">
        <mat-card-content class="p-2">
          <form [formGroup]="itemForm" (ngSubmit)="onPaymentSubmit()" class="compact-form">
            <div class="row g-2">
              <div class="col-6 col-md-3">
                <mat-form-field appearance="outline" class="w-100 compact-field">
                  <mat-label>Amount</mat-label>
                  <input matInput type="number" formControlName="amount" readonly>
                </mat-form-field>
              </div>
              <div class="col-6 col-md-3">
                <mat-form-field appearance="outline" class="w-100 compact-field">
                  <mat-label>Date</mat-label>
                  <input matInput [matDatepicker]="startPicker" formControlName="paymentDate">
                  <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                  <mat-datepicker #startPicker></mat-datepicker>
                </mat-form-field>
              </div>
              <div class="col-6 col-md-3">
                <mat-form-field appearance="outline" class="w-100 compact-field">
                  <mat-label>Method</mat-label>
                  <mat-select formControlName="paymentMethod">
                    <mat-option value="CREDIT_CARD">Card</mat-option>
                    <mat-option value="DEBIT_CARD">Debit</mat-option>
                    <mat-option value="UPI">UPI</mat-option>
                    <mat-option value="CASH">Cash</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col-6 col-md-3">
                <mat-form-field appearance="outline" class="w-100 compact-field">
                  <mat-label>Status</mat-label>
                  <input matInput value="PAID" readonly>
                </mat-form-field>
              </div>
            </div>
            <div class="mt-2 d-flex gap-1 justify-content-center">
              <button mat-raised-button color="accent" size="small" type="submit" [disabled]="itemForm.invalid">Pay
                Now</button>
              <button mat-button size="small" type="button" (click)="reset()">Cancel</button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Paginator -->
  <mat-paginator [pageSize]="3" showFirstLastButtons [length]="dataSource.data.length" class="paginator-compact">
  </mat-paginator>
</mat-card>